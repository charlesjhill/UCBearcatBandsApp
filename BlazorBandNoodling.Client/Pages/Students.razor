@page "/students"
@using BlazorBandNoodling.Shared.Models
@inject HttpClient Http

<h1>Student Operations</h1>

@if (students == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="mb-2">
        <button class="btn btn-primary" type="button" onclick="@AddStudent">
            Add Student
        </button>
        <button class="btn btn-dark" type="button" onclick="@(async () => await AddExampleStudentAsync())">
            Add Example Student
        </button>
    </div>
    

    <table class="table table-striped">
        <caption>List of Students</caption>
        <thead>
            <tr>
                <th scope="col">Last Name</th>
                <th scope="col">First Name</th>
                <th scope="col">M-Number</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var student in students)
            {
                <tr>
                    <td>@student.LastName</td>
                    <td>@student.FirstName</td>
                    <td>@student.MNumber</td>
                    <td class="btn-group">
                        <button class="btn btn-light" onclick="@(async () => await EditStudent(student.ID))">Edit</button>
                        <button class="btn btn-danger" onclick="@(async () => await DeleteConfirm(student.ID))">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (isAddOrEdit)
    {
        <StudentAddModal Title="@ModalTitle" Student="@selectedStudent"
                      OnSave="@SaveStudent" OnCancel="@CloseModal"/>
    }

    @if (isDelete)
    {
        <StudentDeleteModal Title="@ModalTitle" Student="@selectedStudent"
                            OnSave="@DeleteStudent" OnCancel="@CloseModal"/>
    }
}

@functions {
    protected Student[] students;
    protected bool isAddOrEdit = false;
    protected bool isDelete = false;

    protected string ModalTitle { get; set; }
    protected Student selectedStudent = new Student();

    // Initialization/Utility Functions

    protected override async Task OnInitAsync()
    {
        await GetStudents();
    }

    protected async Task GetStudents()
    {
        students = await Http.GetJsonAsync<Student[]>("api/Students");
    }

    protected async Task AddExampleStudentAsync()
    {
        var student = new Student
        {
            FirstName = "Ben",
            LastName = "Hollar",
            MNumber = "M12345678"
        };
        await Http.PostJsonAsync("api/Students", student);

        await GetStudents();
    }

    protected void CloseModal()
    {
        this.isAddOrEdit = false;
        this.isDelete = false;
    }

    // DOM Manipulation Functions

    protected void AddStudent()
    {
        selectedStudent = new Student();
        ModalTitle = "Add Student";
        isAddOrEdit = true;
    }

    protected async Task EditStudent(int id)
    {
        selectedStudent = await Http.GetJsonAsync<Student>($"api/Students/{id}");
        ModalTitle = "Edit Student";
        isAddOrEdit = true;
    }

    protected async Task DeleteConfirm(int id)
    {
        selectedStudent = await Http.GetJsonAsync<Student>($"api/Students/{id}");
        ModalTitle = "Delete Student";
        isDelete = true;
    }

    // DB Interaction Functions

    protected async Task DeleteStudent()
    {
        await Http.DeleteAsync($"api/Students/{selectedStudent.ID}");
        isDelete = false;
        await GetStudents();
    }

    protected async Task SaveStudent()
    {
        if (selectedStudent.ID != 0)
        {
            await Http.PutJsonAsync($"api/Students/{selectedStudent.ID}", selectedStudent);
        }
        else
        {
            await Http.PostJsonAsync($"api/Students", selectedStudent);
        }
        isAddOrEdit = false;
        await GetStudents();

    }

}
